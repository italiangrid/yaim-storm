# vim: filetype=sh
function config_storm_webdav_sa_check () {

requires $1 STORM_USER STORM_STORAGEAREA_LIST VOS
return $?

}

function config_storm_webdav_sa () {

FUNCTION="config_storm_webdav_sa"
config_dir="/etc/storm-webdav/sa.d"

for SA in ${STORM_STORAGEAREA_LIST}; do

  # Convert case
  SA_UPP=`echo ${SA} | tr '[:lower:]' '[:upper:]' | sed -e 's/-//g' -e 's/\.//g'`
  SA_LOW=`echo ${SA} | tr '[:upper:]' '[:lower:]'`

  config_file="${config_dir}/${SA_LOW}.properties"

  yaimlog DEBUG "${FUNCTION}: Configuring storage area ${SA_LOW} in ${config_file}"

  x=STORM_${SA_UPP}_ROOT;                    SA_ROOT=${!x:-${STORM_DEFAULT_ROOT}/${SA_LOW}}
  x=STORM_${SA_UPP}_ACCESSPOINT;             SA_ACCESSPOINT=${!x:-/${SA_LOW}}
  x=STORM_${SA_UPP}_VONAME;                  SA_VONAME=${!x:-${SA_LOW}}
  x=STORM_${SA_UPP}_ANONYMOUS_HTTP_READ;     SA_ANONYMOUS_HTTP_READ=${!x:-${STORM_ANONYMOUS_HTTP_READ}}
  x=STORM_${SA_UPP}_AUTHENTICATED_HTTP_READ;     SA_AUTHENTICATED_HTTP_READ=${!x:-${STORM_AUTHENTICATED_HTTP_READ}}

  aps=""
  for access_point in ${SA_ACCESSPOINT}; do
    yaimlog DEBUG "${FUNCTION}: Adding access point ${access_point} for storage area ${SA_LOW}"

    if [ -z "${aps}" ]; then
      aps="${access_point}"
    else
      aps="${aps},${access_point}"
    fi 
  done

  yaimlog DEBUG "${FUNCTION}: ${SA_LOW} access points: ${aps}"

  vos="${SA_VONAME}"
  if [ "${vos}" = "*" ]; then
    yaimlog INFO "${FUNCTION}: VOMS authorization disabled for storage area ${SA_LOW}"
    vos=""
  fi

  if [ "${SA_ANONYMOUS_HTTP_READ}" = "true" ]; then
    yaimlog DEBUG "${FUNCTION}: Storage area will be readable for anonymous users: ${SA_LOW}"
    SA_AUTHENTICATED_HTTP_READ="true"
  fi

  # Generate storage area configuration
  cat > ${config_file} << EOF
# Autogenerated by YAIM
name=${SA_LOW}
rootPath=${SA_ROOT}
filesystemType=posixfs
accessPoints=${aps}
vos=${vos}
authenticatedReadEnabled=${SA_AUTHENTICATED_HTTP_READ}
anonymousReadEnabled=${SA_ANONYMOUS_HTTP_READ}
EOF
done	
		
# Exit with success
return ${YEX_OK}
}
